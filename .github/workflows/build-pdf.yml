name: Build Resume PDFs

permissions:
  contents: write

on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  build-pdf:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install Pandoc and Chromium
        run: |
          sudo apt-get update
          sudo apt-get install -y pandoc chromium-browser

      - name: Generate PDFs with Chromium
        run: |
          mkdir -p pdf

          # Function to convert markdown to PDF via Chromium
          convert_to_pdf() {
            local input_md=$1
            local output_pdf=$2
            local title=$3
            
            echo "Generating $output_pdf..."
            
            # Convert markdown to HTML with Pandoc
            pandoc "$input_md" -o temp_resume.html \
              --standalone \
              --css=.github/styles/resume.css \
              --metadata title="$title" \
              --embed-resources
            
            # Convert HTML to PDF using Chromium
            chromium-browser --headless=new --disable-gpu \
              --print-to-pdf="$output_pdf" \
              --no-margins \
              --run-all-compositor-stages-before-draw \
              "file://$(pwd)/temp_resume.html"
            
            # Clean up temp file
            rm -f temp_resume.html
          }

          # Generate all PDFs
          convert_to_pdf "jere-cloud-resume-en.md" "pdf/jere-cloud-resume-en.pdf" "Lucas Jeremias Fassi - Cloud Resume"
          convert_to_pdf "jere-cloud-resume-es.md" "pdf/jere-cloud-resume-es.pdf" "Lucas Jeremias Fassi - CV Cloud"
          convert_to_pdf "jere-basic-resume.md" "pdf/jere-basic-resume.pdf" "Lucas Jeremias Fassi - Resume"
          convert_to_pdf "resume-ATS.md" "pdf/resume-ATS.pdf" "Lucas Jeremias Fassi - Resume (ATS)"

          echo "All PDFs generated successfully with emoji support!"

      - name: Commit PDFs
        if: github.ref == 'refs/heads/main'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -f pdf/*.pdf
          if ! git diff --cached --quiet; then
            git commit -m "Update PDF resumes [skip ci]"
            git push
          else
            echo "No PDF changes to commit"
          fi

      - name: Upload PDFs as artifacts (fallback)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pdf-resumes
          path: pdf/*.pdf

      - name: Validate JSON Resume (optional)
        if: hashFiles('resume.json') != ''
        run: |
          npm init -y
          npm install resume-cli@3
          npx resume validate resume.json || echo "Validation failed"
